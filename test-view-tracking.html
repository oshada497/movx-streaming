<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Tracking Test - FBFLIX</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 40px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            color: #f5c518;
            margin-bottom: 30px;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h2 {
            color: #fff;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        button {
            background: #f5c518;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }

        button:hover {
            transform: scale(1.05);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .log {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .success {
            color: #4caf50;
        }

        .error {
            color: #f44336;
        }

        .warning {
            color: #ff9800;
        }

        .info {
            color: #2196f3;
        }

        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status.pass {
            background: #4caf50;
            color: #000;
        }

        .status.fail {
            background: #f44336;
            color: #fff;
        }

        input[type="number"] {
            background: #1a1a1a;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 6px;
            margin-right: 10px;
            width: 100px;
        }

        select {
            background: #1a1a1a;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 6px;
            margin-right: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(245, 197, 24, 0.1);
            color: #f5c518;
            font-weight: 600;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #f5c518;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîç View Tracking System Diagnostics</h1>

        <!-- System Status -->
        <div class="section">
            <h2>System Status</h2>
            <div id="systemStatus">
                <div class="loading"></div> Checking system...
            </div>
        </div>

        <!-- Database Connection Test -->
        <div class="section">
            <h2>Database Connection</h2>
            <button onclick="testDatabaseConnection()">Test Connection</button>
            <button onclick="checkTables()">Check Tables</button>
            <button onclick="checkFunctions()">Check Functions</button>
            <div id="dbStatus" class="log"></div>
        </div>

        <!-- Manual View Tracking Test -->
        <div class="section">
            <h2>Manual View Tracking</h2>
            <div>
                <input type="number" id="testContentId" placeholder="Content ID" value="1">
                <select id="testContentType">
                    <option value="movie">Movie</option>
                    <option value="tv">TV Show</option>
                </select>
                <input type="number" id="testTmdbId" placeholder="TMDB ID" value="550">
                <button onclick="testViewTracking()">Track View</button>
            </div>
            <div id="trackingResult" class="log"></div>
        </div>

        <!-- View History -->
        <div class="section">
            <h2>Recent View History</h2>
            <button onclick="loadViewHistory()">Load History</button>
            <button onclick="clearLogs('viewHistory')">Clear</button>
            <div id="viewHistory" class="log"></div>
        </div>

        <!-- Trending Content -->
        <div class="section">
            <h2>Trending Content</h2>
            <button onclick="loadTrending()">Load Trending</button>
            <button onclick="clearCache()">Clear Cache</button>
            <div id="trendingContent" class="log"></div>
        </div>

        <!-- Console Logs -->
        <div class="section">
            <h2>Console Logs</h2>
            <button onclick="clearLogs('consoleLogs')">Clear Logs</button>
            <div id="consoleLogs" class="log"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth.js"></script>
    <script src="db.js"></script>

    <script>
        // Custom logging
        const logEl = document.getElementById('consoleLogs');

        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        // Override console methods to capture logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function (...args) {
            addLog(args.join(' '), 'info');
            originalLog.apply(console, args);
        };

        console.error = function (...args) {
            addLog(args.join(' '), 'error');
            originalError.apply(console, args);
        };

        console.warn = function (...args) {
            addLog(args.join(' '), 'warning');
            originalWarn.apply(console, args);
        };

        // System Status Check
        async function checkSystemStatus() {
            const statusEl = document.getElementById('systemStatus');
            let html = '';

            // Check if auth is loaded
            const authStatus = typeof window.auth !== 'undefined' && window.auth.supabase;
            html += `<div>Auth System: <span class="status ${authStatus ? 'pass' : 'fail'}">${authStatus ? 'CONNECTED' : 'FAILED'}</span></div>`;

            // Check if DB is loaded
            const dbStatus = typeof window.DB !== 'undefined';
            html += `<div>DB System: <span class="status ${dbStatus ? 'pass' : 'fail'}">${dbStatus ? 'LOADED' : 'FAILED'}</span></div>`;

            // Check if trackView exists
            const trackViewStatus = typeof window.DB?.trackView === 'function';
            html += `<div>trackView Function: <span class="status ${trackViewStatus ? 'pass' : 'fail'}">${trackViewStatus ? 'EXISTS' : 'MISSING'}</span></div>`;

            statusEl.innerHTML = html;
        }

        // Test Database Connection
        async function testDatabaseConnection() {
            const statusEl = document.getElementById('dbStatus');
            statusEl.innerHTML = '<div class="loading"></div> Testing...';

            if (!window.auth || !window.auth.supabase) {
                statusEl.innerHTML = '<div class="error">‚ùå Auth not initialized</div>';
                return;
            }

            try {
                const { data, error } = await window.auth.supabase
                    .from('movies')
                    .select('id, title')
                    .limit(1);

                if (error) throw error;

                statusEl.innerHTML = `<div class="success">‚úÖ Database Connected<br>Sample: ${data[0]?.title || 'No movies found'}</div>`;
            } catch (e) {
                statusEl.innerHTML = `<div class="error">‚ùå Connection Failed: ${e.message}</div>`;
            }
        }

        // Check Tables
        async function checkTables() {
            const statusEl = document.getElementById('dbStatus');
            statusEl.innerHTML = '<div class="loading"></div> Checking tables...';

            if (!window.auth || !window.auth.supabase) {
                statusEl.innerHTML = '<div class="error">‚ùå Auth not initialized</div>';
                return;
            }

            let html = '<table><tr><th>Table</th><th>Status</th><th>Record Count</th></tr>';

            // Check movies
            try {
                const { count, error } = await window.auth.supabase
                    .from('movies')
                    .select('*', { count: 'exact', head: true });

                html += `<tr><td>movies</td><td class="success">‚úÖ</td><td>${count || 0}</td></tr>`;
            } catch (e) {
                html += `<tr><td>movies</td><td class="error">‚ùå</td><td>-</td></tr>`;
            }

            // Check tv_shows
            try {
                const { count, error } = await window.auth.supabase
                    .from('tv_shows')
                    .select('*', { count: 'exact', head: true });

                html += `<tr><td>tv_shows</td><td class="success">‚úÖ</td><td>${count || 0}</td></tr>`;
            } catch (e) {
                html += `<tr><td>tv_shows</td><td class="error">‚ùå</td><td>-</td></tr>`;
            }

            // Check view_history
            try {
                const { count, error } = await window.auth.supabase
                    .from('view_history')
                    .select('*', { count: 'exact', head: true });

                html += `<tr><td>view_history</td><td class="success">‚úÖ</td><td>${count || 0}</td></tr>`;
            } catch (e) {
                html += `<tr><td>view_history</td><td class="error">‚ùå</td><td>-</td></tr>`;
            }

            html += '</table>';
            statusEl.innerHTML = html;
        }

        // Check Functions
        async function checkFunctions() {
            const statusEl = document.getElementById('dbStatus');
            statusEl.innerHTML = '<div class="loading"></div> Checking functions...';

            if (!window.auth || !window.auth.supabase) {
                statusEl.innerHTML = '<div class="error">‚ùå Auth not initialized</div>';
                return;
            }

            let html = '<table><tr><th>Function</th><th>Status</th></tr>';

            // Test increment_view_count
            try {
                const { data, error } = await window.auth.supabase.rpc('increment_view_count', {
                    p_content_id: -1, // Non-existent ID for testing
                    p_content_type: 'movie',
                    p_tmdb_id: 0,
                    p_user_id: null,
                    p_session_id: 'test'
                });

                html += `<tr><td>increment_view_count</td><td class="success">‚úÖ Exists</td></tr>`;
            } catch (e) {
                if (e.message.includes('does not exist')) {
                    html += `<tr><td>increment_view_count</td><td class="error">‚ùå Missing</td></tr>`;
                } else {
                    html += `<tr><td>increment_view_count</td><td class="success">‚úÖ Exists (error expected)</td></tr>`;
                }
            }

            // Test get_trending_content
            try {
                const { data, error } = await window.auth.supabase.rpc('get_trending_content', {
                    days_limit: 30,
                    result_limit: 5
                });

                html += `<tr><td>get_trending_content</td><td class="success">‚úÖ Exists (${data?.length || 0} results)</td></tr>`;
            } catch (e) {
                html += `<tr><td>get_trending_content</td><td class="error">‚ùå ${e.message}</td></tr>`;
            }

            html += '</table>';
            statusEl.innerHTML = html;
        }

        // Test View Tracking
        async function testViewTracking() {
            const contentId = parseInt(document.getElementById('testContentId').value);
            const contentType = document.getElementById('testContentType').value;
            const tmdbId = parseInt(document.getElementById('testTmdbId').value);
            const resultEl = document.getElementById('trackingResult');

            resultEl.innerHTML = '<div class="loading"></div> Tracking view...';

            try {
                const success = await DB.trackView(contentId, contentType, tmdbId);

                if (success) {
                    resultEl.innerHTML = `<div class="success">‚úÖ View tracked successfully!<br>Content ID: ${contentId}<br>Type: ${contentType}<br>TMDB ID: ${tmdbId}</div>`;
                } else {
                    resultEl.innerHTML = '<div class="error">‚ùå View tracking returned false. Check console for errors.</div>';
                }
            } catch (e) {
                resultEl.innerHTML = `<div class="error">‚ùå Error: ${e.message}</div>`;
            }
        }

        // Load View History
        async function loadViewHistory() {
            const historyEl = document.getElementById('viewHistory');
            historyEl.innerHTML = '<div class="loading"></div> Loading...';

            if (!window.auth || !window.auth.supabase) {
                historyEl.innerHTML = '<div class="error">‚ùå Auth not initialized</div>';
                return;
            }

            try {
                const { data, error } = await window.auth.supabase
                    .from('view_history')
                    .select('*')
                    .order('viewed_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                if (!data || data.length === 0) {
                    historyEl.innerHTML = '<div class="warning">‚ö†Ô∏è No view history found</div>';
                    return;
                }

                let html = '<table><tr><th>Content ID</th><th>Type</th><th>TMDB ID</th><th>Viewed At</th></tr>';
                data.forEach(view => {
                    html += `<tr>
                        <td>${view.content_id}</td>
                        <td>${view.content_type}</td>
                        <td>${view.tmdb_id || 'N/A'}</td>
                        <td>${new Date(view.viewed_at).toLocaleString()}</td>
                    </tr>`;
                });
                html += '</table>';

                historyEl.innerHTML = html;
            } catch (e) {
                historyEl.innerHTML = `<div class="error">‚ùå Error: ${e.message}</div>`;
            }
        }

        // Load Trending
        async function loadTrending() {
            const trendingEl = document.getElementById('trendingContent');
            trendingEl.innerHTML = '<div class="loading"></div> Loading...';

            try {
                const trending = await DB.getTrendingContent(30, 10, true); // bypass cache

                if (!trending || trending.length === 0) {
                    trendingEl.innerHTML = '<div class="warning">‚ö†Ô∏è No trending content found</div>';
                    return;
                }

                let html = '<table><tr><th>Title</th><th>Type</th><th>View Count</th></tr>';
                trending.forEach(item => {
                    html += `<tr>
                        <td>${item.title}</td>
                        <td>${item.mediaType}</td>
                        <td>${item.viewCount || item.view_count || 0}</td>
                    </tr>`;
                });
                html += '</table>';

                trendingEl.innerHTML = html;
            } catch (e) {
                trendingEl.innerHTML = `<div class="error">‚ùå Error: ${e.message}</div>`;
            }
        }

        // Clear Cache
        function clearCache() {
            sessionStorage.clear();
            addLog('Cache cleared', 'success');
        }

        // Clear Logs
        function clearLogs(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            addLog('Diagnostic page loaded', 'success');

            // Wait for auth to be ready
            if (window.auth && window.auth.ready) {
                window.auth.ready.then(() => {
                    checkSystemStatus();
                    addLog('Auth system ready', 'success');
                });
            } else {
                setTimeout(checkSystemStatus, 1000);
            }
        });
    </script>
</body>

</html>